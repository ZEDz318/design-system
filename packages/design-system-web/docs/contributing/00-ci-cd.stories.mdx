import { Meta } from '@storybook/addon-docs';

<Meta
  title="Contributing/CI & CD Workflow"
  parameters={{
    previewTabs: {
      canvas: { hidden: true },
    },
  }}
/>

# CI & CD Workflow

In software engineering, CI & CD stands for continuous integration and continuous development (see [wikipedia](https://en.wikipedia.org/wiki/CI/CD)).
We use Github to realize a simple and powerful CI & CD workflow for the development and shipping of this design system.

## Working with Pull Request
For new developments (features or fixes) we use separated branches resulting in pull-requests.

Our development platform listens to pull requests triggering two Github workflows:

- The workflow `Test PR`  builds and tests the application in separate containers.

- The workflow `Dockerize PR` tags the repository with a prerelease tag and creates a docker image.

Tags are generated as follows: a pull request #21 checked out from `main` in version `1.3.0` will receive the version tag `1.3.0-pr-21.0` on the first push, `1.3.0-pr-21.1` on the second, etc.
(see existing tags of [design system repository](https://github.com/geovistory/design-system/tags))

The docker image is pushed to the [container registry of design system](https://github.com/geovistory/design-system/pkgs/container/design-system) with the new version tag.

(Both workflows are triggered automatically on push to pull request branch.)

## Deploy to preview environment
Our deployment platform allows us (the maintainers) to dispatch a workflow to deploy the documentation (storybook) of a version tag to two preview environments. There, other developers, data and UX specialists can easily review a pull request and comment, approve or decline changes in the thread of the GitHub pull request.

The preview environments are:

- `design-dev.geovistory.org` Shows the last deployed version (tag).
- `design-stag.geovistory.org` Shows the last deployed version (tag). On deploy, this version has to be up to date with the `main` branch, which is our default branch.

If a maintainer tries to deploy a version to `design-stag.geovistory.org` that is behind `main`, the deployment workflow fails. This enforces, we deploy only code to staging that contains all commits of `main` branch without having merged to `main` already. This way we avoid blocking the deployment pipeline, by potentially breaking `main` with a (logically conflicting) pull request merge.

To deploy a version to a preview environment, a maintainer has to manually start the workflow `Deploy Storybook`, choosing the tag and environment:


## Merge Pull Request
After a pull request was approved (using `design-stag.geovistory.org`), it will be merged into the `main` branch. A maintainer has to merge the pull request using the GitHub UI and delete the branch.

## Release npm packages
Now a new version can be released. A maintainer has to run the Workflow `Release` from `main` branch, choosing the `type of increment`: `[patch | minor | major]` as specified by [https://semver.org/](https://semver.org/).

In short, choose:

- MAJOR when the version contains breaking changes,
- MINOR when the version adds functionality in a backwards compatible manner, and
- PATCH when the version adds backwards compatible bug fixes.


The `Release` workflow does the following steps:

1. It builds the packages

1. It updates the version according to the given type of increment and commits it to main, e.g.:

    - `patch` : `1.3.2-pr-21.4` -> `1.3.3`
    - `minor` : `1.3.2-pr-21.4` -> `1.4.0`
    - `major` : `1.3.2-pr-21.4` -> `2.0.0`

1. It publishes the packages to npmjs.org (see [npm packages of geovistory](https://www.npmjs.com/~geovistory)).

1. It tags the repository (see [tags of design system repository](https://github.com/geovistory/design-system/tags))

1. It builds and pushes a docker image with the new version (see [docker images of design system](https://github.com/geovistory/design-system/pkgs/container/design-system))

1. It deploys the new version to `design-stag.geovistory.org`


## Deploy to production environment
Regarding the deployed docker images, the production environment of `geovistory.org` is an exact copy of the staging environment. Thus, the deployment of `design-stag.geovistory.org` to `design.geovistory.org` underlies the general mechanism of promoting geovistory apps from staging to production. This can only be executed by the geovistory DevOps team.

